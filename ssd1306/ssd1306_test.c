#define _CRT_SECURE_NO_WARNINGS
#define SDL_MAIN_HANDLED

#include <stdio.h>
#include <string.h>
#include <assert.h>
#ifdef _WIN32
#include <Windows.h>
#endif // _WIN32

#include "ssd1306_api.h"
#include <SDL.h>

static const uint8_t picseq[] = {
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x10,0x0C,0x84,0x84,0x84,0x84,0xC5,0x46,0x44,0x44,0x64,0x44,0x04,0x14,0x0C,0x00,
	0x00,0xFC,0x04,0x04,0xFC,0x00,0x04,0xC4,0x5F,0x44,0xC4,0x44,0x5F,0xC4,0x04,0x00,
	0x40,0x3C,0x10,0xFF,0x10,0x10,0x20,0x10,0x8F,0x78,0x08,0xF8,0x08,0xF8,0x00,0x00,
	0x40,0x42,0xCC,0x00,0x00,0x82,0x92,0x92,0xF2,0x9E,0x92,0x92,0xF2,0x82,0x80,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x04,0x04,0x04,0x04,0x04,0x04,0x3F,0x42,0x42,0x42,0x42,0x42,0x42,0x7A,0x00,0x00,
	0x00,0x0F,0x04,0x04,0x0F,0x00,0x00,0xFF,0x44,0x44,0x7F,0x44,0x44,0xFF,0x00,0x00,
	0x02,0x06,0x02,0xFF,0x01,0x01,0x04,0x42,0x21,0x18,0x46,0x81,0x40,0x3F,0x00,0x00,
	0x00,0x00,0x7F,0x20,0x10,0x00,0xFC,0x44,0x44,0x44,0x44,0x44,0xFC,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x80,0xE0,0xF0,
	0xF0,0xF0,0xF0,0xE0,0xE0,0x80,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x80,0xF0,0xF8,0xFE,0xFE,0xFF,0xFF,
	0xFE,0xFE,0xFC,0xF8,0xE0,0xC0,0x00,0x00,0x00,0x00,0x80,0x80,0x80,0x80,0x80,0x80,
	0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x80,0x00,0x00,0x00,0x80,0xE0,0xF0,0xF8,0xFC,
	0xFE,0xFF,0xFF,0xFF,0xFE,0xFC,0xF0,0xC0,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x80,0xE0,0xE0,0xF0,0xF0,
	0xF0,0xF0,0xE0,0x80,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xFC,0xFF,0xFF,0xFF,
	0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFC,0xFC,0xFC,0xFC,0x3C,0xDC,0xDE,0xDE,0xBE,
	0x7E,0xFE,0xFE,0x7E,0x3E,0xDC,0xEC,0xDC,0x80,0x7F,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,
	0xFF,0xFF,0xFF,0x7F,0xBF,0xDF,0xBF,0x3F,0xDF,0xEF,0x1F,0xFF,0xFF,0xFF,0xFF,0xFF,
	0x7F,0xBF,0xBF,0xBF,0x7F,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,
	0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0x00,0x9C,0xDC,0xDC,0xDE,0xBE,0x7E,0xFE,
	0xFE,0x7E,0xBE,0xBE,0xBC,0xBC,0xBC,0xBC,0xBC,0xBC,0xBF,0xBF,0xBF,0xBF,0xBF,0x7F,
	0xFF,0xFF,0xFF,0xFF,0xFC,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0xE0,0xFC,0xFF,0xFF,0xFF,0xFF,
	0x7F,0xBF,0xBF,0xBF,0xBF,0xBF,0x6F,0xD7,0xDB,0xDB,0xDC,0xDF,0x1F,0x9F,0x9F,0xDF,
	0xDF,0xDE,0xDE,0xCE,0xCF,0xCF,0xCF,0xCF,0xAF,0xAF,0x6C,0xED,0xF3,0xFF,0xFF,0xFF,
	0xFF,0x7F,0x87,0xF8,0xFF,0xFF,0x7F,0x78,0xFF,0xFF,0x3C,0x1D,0x5D,0x03,0xC7,0xF9,
	0xFE,0x7F,0x1F,0x1F,0xDF,0xFC,0xFD,0x3D,0xDD,0x3D,0xBD,0xFB,0xFB,0xF7,0xEF,0xDF,
	0x3F,0xFF,0xFF,0xFF,0xFF,0xFF,0x7F,0xBF,0xD8,0xD7,0xC7,0xD7,0xD7,0x97,0x38,0xFF,
	0xFC,0xBB,0x5B,0x6B,0xF3,0xF3,0xFB,0xFF,0x7F,0x7F,0xF3,0xF3,0xF3,0x73,0x8B,0xFC,
	0xFF,0xFF,0xFF,0xFF,0xFF,0xFC,0xE0,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x06,0x06,0x06,0x86,0x86,0x86,0xFF,0xFF,0xFF,0xFF,0xE7,0x98,
	0x7F,0xFF,0xE7,0xDB,0xDB,0xE7,0xFF,0x7E,0x81,0x07,0xF9,0xFE,0xFF,0x67,0x6B,0x6D,
	0x6E,0x60,0xFF,0xFF,0x60,0x6E,0x6D,0x6B,0x67,0xFF,0xFE,0xF9,0x07,0xFF,0xFF,0xFF,
	0xFF,0x8E,0x75,0x79,0xB9,0xBC,0x1C,0xFE,0xFF,0xFF,0x0F,0xF7,0xF7,0xF8,0x1E,0xE6,
	0xF2,0x7C,0x9E,0x6F,0xB7,0xD9,0xE6,0xFB,0x7D,0x9E,0xCF,0xF7,0x31,0xC1,0xFF,0xFF,
	0x3E,0xC1,0xFF,0xFF,0xFF,0xFF,0xFE,0xFD,0xFD,0x05,0xF9,0xFF,0xFF,0x0F,0xF0,0xF7,
	0xEB,0xED,0x6E,0xAE,0x8F,0xCF,0xCF,0xCE,0xCE,0xCE,0xCF,0xCF,0xAF,0x6E,0xEE,0xEE,
	0xED,0xF3,0xFF,0xFF,0xFF,0xFF,0xFF,0x86,0x86,0x86,0x06,0x06,0x06,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x03,0x03,0xC3,0xC1,0xE1,0x61,0x63,0x7F,0x3F,0x7F,0xFF,
	0xFF,0xFE,0xFD,0xFD,0xFD,0xFD,0xFE,0xFF,0xFF,0xFC,0xF3,0xEF,0xDF,0xBC,0xBB,0x77,
	0x77,0x70,0x7F,0x7F,0x70,0x77,0x77,0xBB,0xBC,0xDF,0x2F,0xF1,0xFE,0xFF,0xFF,0xFF,
	0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0xC0,0xBF,0x7F,0x7F,0x80,0xFF,0xFF,0xFF,0xFF,0xFE,
	0xFE,0xF1,0xEE,0xEF,0xB7,0x5B,0x6D,0x6E,0x77,0x7B,0xBB,0xDC,0xDF,0xEF,0xF3,0xFD,
	0xFE,0xFF,0xFF,0xFF,0xFF,0xFF,0x7F,0x9F,0xC0,0xBF,0x7F,0x7F,0x7D,0xBC,0xCD,0xF3,
	0xFF,0xC0,0xBF,0x7F,0x7F,0x71,0x75,0x6D,0x6D,0x75,0x71,0x7F,0xBF,0xBF,0xCE,0xF1,
	0xFF,0xFF,0x7F,0x3F,0x7F,0x63,0x61,0xE1,0xC1,0xC3,0x03,0x03,0x00,0x00,0x00,0x00,
	0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
	0x01,0x03,0x03,0x07,0x07,0x0F,0x0F,0x0F,0x1F,0x1F,0x1F,0x1F,0x1F,0x3F,0x3F,0x3F,
	0x3F,0x3F,0x3F,0x3F,0x1F,0x1F,0x1F,0x1F,0x1F,0x0F,0x0F,0x0E,0x05,0x03,0x07,0x07,
	0x0F,0x0F,0x1F,0x1F,0x3F,0x3F,0x3F,0x7F,0x7F,0x7F,0x7F,0x7F,0xFF,0xFF,0xFF,0xFF,
	0xFF,0xFF,0xFF,0xFF,0xFF,0xFF,0x7F,0x7F,0x7F,0x7F,0x3F,0x3F,0x3F,0x1F,0x1F,0x0F,
	0x0F,0x07,0x07,0x03,0x05,0x0E,0x0F,0x0F,0x1F,0x1F,0x1F,0x1F,0x1F,0x3F,0x3F,0x3F,
	0x3F,0x3F,0x3F,0x3F,0x1F,0x1F,0x1F,0x1F,0x1F,0x0F,0x0F,0x0F,0x07,0x07,0x03,0x03,
	0x01,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,0x00,
};

static const uint8_t bootseq[] = {
	0x0ae,				/* display off, sleep mode */
	0x0d5, 0x0f0,		/* clock divide ratio (0x00=1) and oscillator frequency (0x8) */
	0x0a8, 0x03f,		/* */

	0x0d3, 0x000,		/* set diaplay offset = 0 */

	0x040,				/* start line = 0 */

	0x08d, 0x014,		/* [2] charge pump setting (p62): 0x014 enable, 0x010 disable */

	0x020, 0x000,		/* */
	0x0a1,				/* segment remap a0/a1*/
	0x0c8,				/* c0: scan dir normal, c8: reverse */
	0x0da, 0x012,		/* com pin HW config, sequential com pin config (bit 4), disable left/right remap (bit 5) */
	0x081, 0x07f,		/* [2] set contrast control */
	0x0d9, 0x0f1,		/* [2] pre-charge period 0x022/f1*/
	0x0db, 0x040,		/* vcomh deselect level */

	0x02e,				/* 2012-05-27: Deactivate scroll */
	0x0a4,				/* output ram to display */
	0x0a6,				/* none inverted normal display mode */
	0x0af,				/* display on */
};

void DebugPrint(const char *str) {
	fputs(str, stderr);
}

int SDLCALL thddatafetch(void *d) {
	SSD1306_HANDLE h = (SSD1306_HANDLE)d;
	char buf[128];
	int data;
	while (h->running) {
		fgets(buf, 128, stdin);
		if (sscanf(buf, "d%i", &data) == 1) {
			//data
			fprintf(stderr, "Data: 0x%02X\n", data & 0xFF);
			ssd1306_dcselect(h, true);
			ssd1306_spishiftin(h, data & 0xFF);
		} else if (sscanf(buf, "c%i", &data) == 1) {
			//command
			fprintf(stderr, "Cmd:  0x%02X\n", data & 0xFF);
			ssd1306_dcselect(h, false);
			ssd1306_spishiftin(h, data & 0xFF);
		} else if (buf[0] == 'n') {
			//next clock
			fprintf(stderr, "Clock\n");
			ssd1306_clock(h);
		} else if (buf[0] == 'b' && buf[1] == 'o' && buf[2] == 'o' && buf[3] == 't') {
			fprintf(stderr, "Reboot\n");
			ssd1306_dcselect(h, false);
			for (size_t i = 0; i < sizeof(bootseq) / sizeof(bootseq[0]); i++) {
				ssd1306_spishiftin(h, bootseq[i]);
			}
		} else if (buf[0] == 'p' && buf[1] == 'i' && buf[2] == 'c') {
			fprintf(stderr, "Paint pic\n");
			ssd1306_dcselect(h, true);
			for (size_t i = 0; i < sizeof(picseq) / sizeof(picseq[0]); i++) {
				ssd1306_spishiftin(h, picseq[i]);
			}
		} else if (strncmp(buf, "end", 3) == 0) {
			//end
			h->running = false;
		} else {
			fprintf(stderr, "Wrong command: %s", buf);
		}
	}
	return 0;
}

int main(int argc, char **argv) {
#ifdef _WIN32
	//SetProcessDPIAware();
#endif // _WIN32
	SSD1306_HANDLE h = ssd1306_new("SSD1306 Test");
	assert(h);
	SDL_Thread *thd = SDL_CreateThread(thddatafetch, "data fetch", h);
	bool waitthread = true;

	while (h->running) {
		SDL_Event e;
		while (SDL_PollEvent(&e)) {
			if (e.type == SDL_QUIT) {
				h->running = false;
				waitthread = false;
			}
			if (e.type == SDL_KEYDOWN) {
				//running = false;
			}
			if (e.type == SDL_MOUSEBUTTONDOWN) {
				//running = false;
			}
		}
		ssd1306_refresh(h);
		SDL_Delay(10);
	}

	if (waitthread) {
		SDL_WaitThread(thd, NULL);
	} else {
		SDL_DetachThread(thd);
	}
	ssd1306_destroy(h);
	return 0;
}
